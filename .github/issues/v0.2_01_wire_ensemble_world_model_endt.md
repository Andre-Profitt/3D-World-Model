# [TASK] Wire Ensemble World Model End-to-End

Labels: task, enhancement, v0.2

---

## Task: Wire Ensemble World Model End-to-End

**Milestone:** v0.2
**Section:** Uncertainty & Evaluation
**Estimated Time:** 8 hours
**Priority:** P0

### Specification
Make the ensemble option fully functional and integrated into both training and MPC, enabling uncertainty-aware world models.

### Implementation Checklist

#### Code Changes
- [ ] `config.py`: Add `use_ensemble` and `ensemble_size` parameters
- [ ] `models/world_model.py`: Implement `EnsembleWorldModel` class
- [ ] `training/train_world_model.py`: Add ensemble training with bootstrap sampling
- [ ] `models/mpc_controller.py`: Update to handle ensemble predictions
- [ ] `scripts/run_mpc_agent.py`: Support loading ensemble checkpoints

#### Specific Work Items

1. **Config & CLI** (30 min)
   - [ ] Add `MODEL_CONFIG["use_ensemble"]: bool`
   - [ ] Add `MODEL_CONFIG["ensemble_size"]: int`
   - [ ] Add CLI flags `--use_ensemble` and `--ensemble_size`

2. **Model Construction** (1 hour)
   - [ ] Create `EnsembleWorldModel` wrapper class
   - [ ] Implement `forward(obs, action, reduce="mean"|"none")`
   - [ ] Handle ensemble member initialization

3. **Training Loop** (2 hours)
   - [ ] Implement bootstrap sampling for each member
   - [ ] Save checkpoints as `world_model_member_{i}.pt`
   - [ ] Track per-member and aggregate losses

4. **MPC Integration** (2 hours)
   - [ ] Query all ensemble members during rollout
   - [ ] Compute mean and variance of predictions
   - [ ] Implement risk-sensitive objective: `score = mean_return - lambda_risk * std_return`
   - [ ] Add `lambda_risk` to MPC_CONFIG

#### Tests
- [ ] Unit test for `EnsembleWorldModel.forward()`
- [ ] Test bootstrap sampling produces different datasets
- [ ] Test risk-sensitive planning changes behavior
- [ ] Verify ensemble reduces prediction variance

#### Documentation
- [ ] Add ensemble explanation to README
- [ ] Document risk-sensitive planning usage
- [ ] Add config example for ensemble mode

### Definition of Done
- [ ] Training with `--use_ensemble True --ensemble_size 5` produces 5 model files
- [ ] MPC logs include mean and variance of predicted returns
- [ ] Risk-sensitive planning (`lambda_risk > 0`) shows more conservative behavior
- [ ] README updated with ensemble documentation
